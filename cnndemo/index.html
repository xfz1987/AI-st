<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>åˆ©ç”¨ç¥ç»ç½‘ç»œè¯†åˆ«è½¦logo</title>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
	<img src="http://p.pstatp.com/avatar/100x100/1dd5000018fab5bd782b.png" id="some_image" crossorigin="anonymous" />
	<input type="button" value="æµ‹è¯•" id="test" />
    <script src="./net/car.js"></script>
    <script src="./net/convnet.js"></script>
    <script>
    	/**
    	 * å·ç§¯ç¥ç»ç½‘ç»œ
    	 * type:input   è¾“å…¥å±‚
    	 * type:conv    å·ç»§å±‚
    	 * type:pool    æ± åŒ–å±‚
    	 * type:softmax åˆ†ç±»å±‚
    	 * net.forward(x) é¢„æœŸç»“æœ
    	 * out_sx: 100, out_sy: 100 è¾“å…¥çš„å›¾åƒæ˜¯100 X 100çš„ | out_depth è¡¨ç¤ºæ·±åº¦
    	 * å°†è¾“å…¥çš„å›¾ç‰‡ä¸æ–­çš„è½¬åŠ¨ï¼Œä»è€Œè¿›è¡Œåƒç´ ç‚¹æ¯”å¯¹
    	 */
    	let layer_defs = [];
        layer_defs.push({ type: 'input', out_sx: 100, out_sy: 100, out_depth: 3 });
        layer_defs.push({ type: 'conv', sx: 5, filters: 16, stride: 1, pad: 2, activation: 'relu' });
        layer_defs.push({ type: 'pool', sx: 2, stride: 2 });
        layer_defs.push({ type: 'conv', sx: 5, filters: 20, stride: 1, pad: 2, activation: 'relu' });
        layer_defs.push({ type: 'pool', sx: 2, stride: 2 });
        layer_defs.push({ type: 'conv', sx: 5, filters: 20, stride: 1, pad: 2, activation: 'relu' });
        layer_defs.push({ type: 'pool', sx: 2, stride: 2 });
        layer_defs.push({ type: 'softmax', num_classes: 10 });

        // åˆ›å»ºè¦è®­ç»ƒçš„ç¥ç»ç½‘ç»œ
        const net = new convnetjs.Net();
        // å°†å±‚åŠ å…¥åˆ°ç¥ç»ç½‘ç»œ
        net.makeLayers(layer_defs);
        // è¿›è¡Œè®­ç»ƒï¼ˆè¿›è¡Œè°ƒå‚ï¼Œè°ƒæ•´å­¦ä¹ å‘¨æœŸï¼Œæ‰¹é‡å¤„ç†å¤šå°‘...ï¼‰
        const trainer = new convnetjs.SGDTrainer(net, { learning_rate: 0.01, momentum: 0.9, batch_size: 5, l2_decay: 0.0 });
        
        let imageList = [];
        
        const loadData = i => {
        	return function () {
            	return new Promise(function (resolve, reject) {
            	    let image = new Image();
            	    image.crossOrigin = 'anonymous';
            	    image.src = carList[i].url;
            	    image.onload = function () {
            	    	// å°†å›¾ç‰‡è½¬æˆçŸ¢é‡
            	        let vol = convnetjs.img_to_vol(image);
            	        // è®­ç»ƒ: æŠŠå›¾ç‰‡ä¸è®­ç»ƒæœºå…³è”èµ·æ¥
            	        trainer.train(vol, i);
            	        resolve();
            	    };
            	    image.onerror = reject;
            	})
        	}
        };
        
        // æŠŠæ‰€æœ‰å›¾ç‰‡éƒ½äº¤ç»™è®­ç»ƒæœº
        for (var i = 0; i < carList.length; i++) {
            imageList.push(loadData(i));
        }

        // å¼€å§‹è®­ç»ƒ
        $("#test").click(function () {
            const carNameList = ["å¥¥è¿ª", "å¥”é©°", "å®é©¬", "æœ¬ç”°", "åˆ«å…‹", "æ¯”äºšè¿ª", "ä¿æ—¶æ·", "å¤§ä¼—", "å“ˆå¼—"];
            Promise.all(imageList.map(imageContainer => imageContainer())).then(function () {
            	// å°†ç›®æ ‡å›¾ç‰‡è½¬æˆçŸ¢é‡
                const x = convnetjs.img_to_vol(document.getElementById('some_image'));
                // å°†æ‰€æœ‰å›¾çŸ¢é‡è·Ÿ ç›®æ ‡å›¾çš„çŸ¢é‡è¿›è¡Œæ¯”å¯¹
                console.log(net.forward(x))
                const result = Array.from(net.forward(x).w);//ç»“æœéƒ½åœ¨wä¸Š
                // æ‰¾æœ€å¤§æ¦‚ç‡çš„ç»“æœ
                let max = Math.max.apply(Math, result);
                console.log("æœ€æœ‰å¯èƒ½çš„é‚£ä¸ªæ±½è½¦logoğŸš—", carNameList[result.indexOf(max)])
            });
        });
    </script>
</body>
</html>